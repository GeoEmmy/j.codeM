<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì–´ì…ˆë¸”ë¦¬ ë¹„êµ - J.codE M</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/common.css">
  <style>
    /* ë©”ì¸ ë„¤ë¹„ê²Œì´ì…˜ */
    .main-nav {
      position: sticky;
      top: 0;
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 20px 50px;
      background: rgba(255, 255, 255, 0.98);
      backdrop-filter: blur(10px);
      box-shadow: 0 1px 0 rgba(0, 0, 0, 0.05);
      gap: 40px;
    }

    /* ë¡œê³  */
    .nav-brand .brand-link {
      display: flex;
      align-items: center;
      gap: 4px;
      text-decoration: none;
      font-size: 26px;
      font-weight: 700;
      letter-spacing: -1.5px;
      transition: opacity 0.3s ease;
    }

    .nav-brand .brand-link:hover {
      opacity: 0.7;
    }

    .logo-text {
      color: var(--dark);
    }

    .logo-accent {
      color: var(--primary-color);
    }



    .nav-btn {
      position: relative;
      padding: 10px 28px;
      background: transparent;
      border: none;
      text-decoration: none;
      color: #636e72;
      font-size: 15px;
      font-weight: 600;
      letter-spacing: -0.3px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      cursor: pointer;
      border-radius: 10px;
    }

    .nav-btn::before {
      content: '';
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 0;
      height: 2px;
      background: var(--primary-color);
      transition: width 0.3s ease;
    }

    .nav-btn:hover {
      color: var(--primary-color);
      background: rgba(0, 184, 148, 0.05);
    }

    .nav-btn:hover::before {
      width: 60%;
    }

    .nav-btn.active {
      color: white;
      background: linear-gradient(135deg, #00b894 0%, #00a281 100%);
      box-shadow: 0 4px 15px rgba(0, 184, 148, 0.25);
    }

    .nav-btn.active::before {
      display: none;
    }

    /* ìš°ì¸¡ ì•¡ì…˜ ë²„íŠ¼ */
    .nav-actions {
      display: flex;
      gap: 12px;
    }

    .action-btn {
      padding: 10px 24px;
      background: white;
      border: 1.5px solid #e8ecf1;
      border-radius: 10px;
      text-decoration: none;
      color: #636e72;
      font-size: 14px;
      font-weight: 600;
      letter-spacing: -0.2px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      cursor: pointer;
    }

    .comparison-btn {
      color: var(--primary-color);
      border-color: rgba(0, 184, 148, 0.3);
      background: rgba(0, 184, 148, 0.03);
    }

    .comparison-btn.active {
      color: white;
      background: linear-gradient(135deg, #00b894 0%, #00a281 100%);
      border-color: var(--primary-color);
      box-shadow: 0 4px 15px rgba(0, 184, 148, 0.25);
    }

    .comparison-btn:hover:not(.active) {
      background: var(--primary-color);
      border-color: var(--primary-color);
      color: white;
      box-shadow: 0 4px 15px rgba(0, 184, 148, 0.25);
      transform: translateY(-1px);
    }

    .home-btn:hover {
      border-color: var(--primary-color);
      color: var(--primary-color);
      background: rgba(0, 184, 148, 0.03);
      transform: translateY(-1px);
    }

    /* ë°˜ì‘í˜• - íƒœë¸”ë¦¿ */
    @media (max-width: 1024px) {
      .main-nav {
        padding: 16px 30px;
        gap: 25px;
      }

      .nav-btn {
        padding: 9px 22px;
        font-size: 14px;
      }

      .action-btn {
        padding: 9px 20px;
        font-size: 13px;
      }

      .nav-brand .brand-link {
        font-size: 23px;
      }
    }

    /* ë°˜ì‘í˜• - ëª¨ë°”ì¼ */
    @media (max-width: 768px) {
      .main-nav {
        padding: 14px 20px;
        gap: 15px;
      }

      .nav-btn {
        padding: 8px 16px;
        font-size: 13px;
      }

      .action-btn {
        padding: 8px 16px;
        font-size: 12px;
      }

      .nav-brand .brand-link {
        font-size: 20px;
      }

      .nav-menu {
        gap: 6px;
      }

      .nav-actions {
        gap: 8px;
      }
    }

    /* ë” ì‘ì€ ëª¨ë°”ì¼ */
    @media (max-width: 480px) {
      .main-nav {
        padding: 12px 15px;
        gap: 10px;
      }

      .nav-btn {
        padding: 7px 12px;
        font-size: 12px;
      }

      .action-btn {
        padding: 7px 12px;
        font-size: 11px;
      }
    }

    /* í†µê³„ ì¹´ë“œ */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 40px;
    }

    .stat-card {
      background: white;
      padding: 25px;
      border-radius: 15px;
      box-shadow: var(--shadow);
      text-align: center;
    }

    .stat-card .icon {
      font-size: 32px;
      margin-bottom: 10px;
    }

    .stat-card .label {
      font-size: 12px;
      color: #636e72;
      margin-bottom: 8px;
    }

    .stat-card .value {
      font-size: 28px;
      font-weight: 700;
      color: var(--dark);
    }

    .stat-card .unit {
      font-size: 12px;
      color: #b2bec3;
      margin-top: 5px;
    }

    /* ì–´ì…ˆë¸”ë¦¬ ë¦¬ìŠ¤íŠ¸ */
    .assemblies-section {
      margin-bottom: 40px;
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .section-header h2 {
      font-size: 24px;
      font-weight: 700;
    }

    .section-header .actions {
      display: flex;
      gap: 10px;
    }

    .assemblies-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
      gap: 20px;
    }

    .assembly-card {
      background: white;
      border-radius: 15px;
      padding: 25px;
      box-shadow: var(--shadow);
      transition: var(--transition);
      position: relative;
      border-left: none; /* 5px solid var(--primary-color); */
    }

    .assembly-card:hover {
      transform: translateY(-5px);
      box-shadow: var(--shadow-hover);
    }

    .assembly-card .preview-3d-small {
      width: 100%;
      height: 150px;
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      border-radius: 10px;
      margin-bottom: 15px;
      position: relative;
      overflow: hidden;
    }

    .assembly-card .card-header {
      display: flex;
      justify-content: space-between;
      align-items: start;
      margin-bottom: 15px;
    }

    .assembly-card .assembly-name {
      font-size: 18px;
      font-weight: 600;
      color: var(--dark);
      margin-bottom: 5px;
    }

    .assembly-card .assembly-type {
      font-size: 12px;
      color: #636e72;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .assembly-card .carbon-display-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin: 15px 0;
    }

    .assembly-card .carbon-display {
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      color: white;
      padding: 15px;
      border-radius: 10px;
      text-align: center;
    }

    .assembly-card .carbon-display.total {
      background: linear-gradient(135deg, #6c5ce7, #a29bfe);
    }

    .assembly-card .carbon-display .label {
      font-size: 11px;
      opacity: 0.85;
      margin-bottom: 5px;
    }

    .assembly-card .carbon-display .value {
      font-size: 24px;
      font-weight: 700;
    }

    .assembly-card .carbon-display .unit {
      font-size: 11px;
      margin-top: 5px;
      opacity: 0.9;
    }

    .assembly-card .layers-list {
      margin: 15px 0;
    }

    .assembly-card .layer-tag {
      display: inline-block;
      background: var(--bg-light);
      padding: 5px 10px;
      border-radius: 6px;
      font-size: 11px;
      margin: 3px;
      color: #636e72;
    }

    .assembly-card .metadata {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 15px;
      padding-top: 15px;
      border-top: 1px solid var(--light-gray);
      font-size: 11px;
      color: #95a5a6;
    }

    .assembly-card .actions {
      display: flex;
      gap: 8px;
      margin-top: 15px;
    }

    .assembly-card .actions button {
      flex: 1;
      padding: 8px;
      font-size: 12px;
    }

    /* ë¹„êµ ì°¨íŠ¸ */
    .comparison-section {
      background: white;
      padding: 30px;
      border-radius: 15px;
      box-shadow: var(--shadow);
      margin-bottom: 40px;
    }

    .comparison-section h2 {
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 20px;
    }

    .chart-container {
      position: relative;
      height: 420px;
      margin-top: 20px;
      padding-top: 40px;
      overflow: visible;
    }

    .bar-chart {
      display: flex;
      align-items: flex-end;
      gap: 20px;
      height: 360px;
      padding: 0 0 20px 0;
    }

    .bar-item {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
    }

    .bar {
      width: 100%;
      background: linear-gradient(to top, var(--primary-color), var(--secondary-color));
      border-radius: 10px 10px 0 0;
      position: relative;
      transition: var(--transition);
      cursor: pointer;
      min-height: 1px;
    }

    .bar:hover {
      transform: scaleY(1.05);
      box-shadow: 0 -5px 20px rgba(0, 184, 148, 0.3);
    }

    .bar .value-label {
      position: absolute;
      top: -25px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 12px;
      font-weight: 600;
      color: var(--dark);
      white-space: nowrap;
    }

    .bar-label {
      font-size: 12px;
      text-align: center;
      color: #636e72;
      max-width: 100%;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* í•„í„°/íƒ­ */
    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .tab-btn {
      padding: 10px 20px;
      background: white;
      border: 2px solid var(--light-gray);
      border-radius: 10px;
      font-size: 13px;
      cursor: pointer;
      transition: var(--transition);
      font-family: 'Poppins', sans-serif;
      font-weight: 500;
    }

    .tab-btn.active {
      background: var(--primary-color);
      color: white;
      border-color: var(--primary-color);
    }

    .tab-btn:hover {
      border-color: var(--primary-color);
    }

    .empty-state {
      text-align: center;
      padding: 80px 20px;
      color: #b2bec3;
    }

    .empty-state .icon {
      font-size: 64px;
      margin-bottom: 20px;
    }

    .empty-state h3 {
      font-size: 20px;
      margin-bottom: 10px;
      color: #636e72;
    }

    .empty-state p {
      font-size: 14px;
      margin-bottom: 25px;
    }

    /* ëª¨ë‹¬ */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 9999;
      justify-content: center;
      align-items: center;
    }

    .modal.show {
      display: flex;
    }

    .modal-content {
      background: white;
      border-radius: 20px;
      padding: 40px;
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    }

    .modal-content h3 {
      font-size: 24px;
      margin-bottom: 20px;
    }

    .modal-content .detail-grid {
      display: grid;
      gap: 15px;
    }

    .modal-content .detail-item {
      padding: 15px;
      background: var(--bg-light);
      border-radius: 10px;
    }

    .modal-content .detail-label {
      font-size: 12px;
      color: #636e72;
      margin-bottom: 5px;
    }

    .modal-content .detail-value {
      font-size: 16px;
      font-weight: 600;
      color: var(--dark);
    }

    .modal-close {
      position: absolute;
      top: 20px;
      right: 20px;
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #636e72;
    }

    @media (max-width: 768px) {
      .assemblies-grid {
        grid-template-columns: 1fr;
      }

      .bar-chart {
        flex-direction: column;
        height: auto;
      }

      .bar-item {
        width: 100%;
        flex-direction: row;
        height: 60px;
      }

      .bar {
        height: 100%;
        width: auto;
        border-radius: 0 10px 10px 0;
      }
    }
  </style>
</head>
<body>
  <!-- ë©”ì¸ ë„¤ë¹„ê²Œì´ì…˜ -->
  <nav class="main-nav">
    <!-- ì¢Œì¸¡: ë¡œê³  -->
    <div class="nav-brand">
      <a href="index.html" class="brand-link">
        <span class="logo-text">J.codE</span>
        <span class="logo-accent">M</span>
      </a>
    </div>
    

    <!-- ìš°ì¸¡: ì•¡ì…˜ ë²„íŠ¼ -->
    <div class="nav-actions">
      <a href="assembly-comparison.html" class="action-btn comparison-btn active">
        ì–´ì…ˆë¸”ë¦¬ ë¹„êµ
      </a>
      <a href="index.html" class="action-btn home-btn">
        ë©”ì¸ìœ¼ë¡œ
      </a>
    </div>
  </nav>

  <div class="container">
    <!-- í˜ì´ì§€ í—¤ë” -->
    <div class="page-header">
      <h2>ì–´ì…ˆë¸”ë¦¬ ë¹„êµ</h2>
      <p>ì €ì¥ëœ ì–´ì…ˆë¸”ë¦¬ì˜ íƒ„ì†Œë°°ì¶œëŸ‰ì„ ë¹„êµí•˜ê³  ë¶„ì„í•˜ì„¸ìš”</p>
    </div>

    <!-- í†µê³„ -->
    <div class="stats-grid" id="statsGrid"></div>

    <!-- ë¹„êµ ì°¨íŠ¸ -->
    <div class="comparison-section" id="comparisonSection">
      <div class="section-header">
        <h3>íƒ„ì†Œ ë°°ì¶œëŸ‰ ë¹„êµ</h3>
        <div class="actions">
          <button class="btn btn-secondary" onclick="exportData()">
            ğŸ“¥ CSV ë‚´ë³´ë‚´ê¸°
          </button>
        </div>
      </div>
      <div class="tabs" id="chartTabs">
        <button class="tab-btn active" onclick="filterChart('all')">ì „ì²´</button>
        <button class="tab-btn" onclick="filterChart('floor')">ğŸ—ï¸ ë°”ë‹¥</button>
        <button class="tab-btn" onclick="filterChart('external')">ğŸ¢ ì™¸ë²½</button>
        <button class="tab-btn" onclick="filterChart('internal')">ğŸšª ë‚´ë²½</button>
        <button class="tab-btn" onclick="filterChart('roof')">ğŸ  ì§€ë¶•</button>
      </div>
      <div class="chart-container">
        <div class="bar-chart" id="barChart"></div>
      </div>
    </div>

    <!-- ì–´ì…ˆë¸”ë¦¬ ë¦¬ìŠ¤íŠ¸ -->
    <div class="assemblies-section">
      <div class="section-header">
        <h3>ì €ì¥ëœ ì–´ì…ˆë¸”ë¦¬</h3>
        <div class="actions">
          <button class="btn btn-primary" onclick="createNewAssembly()">
            â• ìƒˆ ì–´ì…ˆë¸”ë¦¬
          </button>
          <button class="btn btn-danger" onclick="clearAllAssemblies()">
            ğŸ—‘ï¸ ì „ì²´ ì‚­ì œ
          </button>
        </div>
      </div>
      <div class="tabs" id="assemblyTabs">
        <button class="tab-btn active" onclick="filterAssemblies('all')">ì „ì²´</button>
        <button class="tab-btn" onclick="filterAssemblies('floor')">ğŸ—ï¸ ë°”ë‹¥</button>
        <button class="tab-btn" onclick="filterAssemblies('external')">ğŸ¢ ì™¸ë²½</button>
        <button class="tab-btn" onclick="filterAssemblies('internal')">ğŸšª ë‚´ë²½</button>
        <button class="tab-btn" onclick="filterAssemblies('roof')">ğŸ  ì§€ë¶•</button>
      </div>
      <div class="assemblies-grid" id="assembliesGrid"></div>
    </div>
  </div>

  <!-- ìƒì„¸ ëª¨ë‹¬ -->
  <div class="modal" id="detailModal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div class="modal-content">
      <button class="modal-close" onclick="closeModal()" aria-label="ë‹«ê¸°">âœ•</button>
      <div id="modalContent"></div>
    </div>
  </div>

  <script src="data/epd-korea.js"></script>
  <script src="js/calculator.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"
          integrity="sha384-C7h9bKdF/Gm5GIiH5DnLF+6T7jSEv4nx4rvQxPX6zCJf+gqDvPvmPZDzOVGOjhRb"
          crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"
          integrity="sha512-dLxUelApnYxpLt6K2iomGngnHO83iUvZytA3YjDUCjT0HDOHKXnVYdf3hU4JjM8uEhxf9nD1/ey98U3t2vZ0qQ=="
          crossorigin="anonymous"
          referrerpolicy="no-referrer"></script>
  <script>
    // XSS ë°©ì§€ë¥¼ ìœ„í•œ HTML ì´ìŠ¤ì¼€ì´í”„ í•¨ìˆ˜
    function escapeHtml(text) {
      if (text == null) return '';
      const div = document.createElement('div');
      div.textContent = String(text);
      return div.innerHTML;
    }

    let currentFilter = 'all';
    let currentChartFilter = 'all';

    // Three.js ë¦¬ì†ŒìŠ¤ ê´€ë¦¬ë¥¼ ìœ„í•œ ë°°ì—´
    const threeResources = [];

    // ì´ˆê¸°í™”
    function init() {
      updateStats();
      renderChart();
      renderAssemblies();
    }

    // í†µê³„ ì—…ë°ì´íŠ¸
    function updateStats() {
      const allAssemblies = calculator.getAllAssemblies();
      const statsGrid = document.getElementById('statsGrid');

      // ì´ ë°°ì¶œëŸ‰
      const totalCarbon = allAssemblies.reduce((sum, a) => sum + a.totalCarbon, 0);

      // íƒ€ì…ë³„ ë°°ì¶œëŸ‰ ê³„ì‚°
      const floorCarbon = calculator.getAssembliesByType('floor').reduce((sum, a) => sum + a.totalCarbon, 0);
      const externalCarbon = calculator.getAssembliesByType('external').reduce((sum, a) => sum + a.totalCarbon, 0);
      const internalCarbon = calculator.getAssembliesByType('internal').reduce((sum, a) => sum + a.totalCarbon, 0);
      const roofCarbon = calculator.getAssembliesByType('roof').reduce((sum, a) => sum + a.totalCarbon, 0);

      statsGrid.innerHTML = `
        <div class="stat-card">
          <div class="label">ì´ ë°°ì¶œëŸ‰</div>
          <div class="value">${formatNumber(totalCarbon, 0)}</div>
          <div class="unit">kg COâ‚‚eq</div>
        </div>
        <div class="stat-card">
          <div class="label">ë°”ë‹¥ ë°°ì¶œëŸ‰</div>
          <div class="value">${formatNumber(floorCarbon, 0)}</div>
          <div class="unit">kg COâ‚‚eq</div>
        </div>
        <div class="stat-card">
          <div class="label">ì™¸ë²½ ë°°ì¶œëŸ‰</div>
          <div class="value">${formatNumber(externalCarbon, 0)}</div>
          <div class="unit">kg COâ‚‚eq</div>
        </div>
        <div class="stat-card">
          <div class="label">ë‚´ë²½ ë°°ì¶œëŸ‰</div>
          <div class="value">${formatNumber(internalCarbon, 0)}</div>
          <div class="unit">kg COâ‚‚eq</div>
        </div>
        <div class="stat-card">
          <div class="label">ì§€ë¶• ë°°ì¶œëŸ‰</div>
          <div class="value">${formatNumber(roofCarbon, 0)}</div>
          <div class="unit">kg COâ‚‚eq</div>
        </div>
      `;
    }

    // ì°¨íŠ¸ ë Œë”ë§
    function renderChart() {
      const assemblies = currentChartFilter === 'all' 
        ? calculator.getAllAssemblies()
        : calculator.getAssembliesByType(currentChartFilter);
      
      const chartContainer = document.getElementById('barChart');
      
      if (assemblies.length === 0) {
        chartContainer.innerHTML = `
          <div class="empty-state" style="width: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%;">
            <div class="icon">ğŸ“Š</div>
            <h3>ë¹„êµí•  ì–´ì…ˆë¸”ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤</h3>
            <p>ìì¬ë¥¼ ì„ íƒí•˜ì—¬ ì–´ì…ˆë¸”ë¦¬ë¥¼ ë§Œë“¤ì–´ë³´ì„¸ìš”</p>
            <button class="btn btn-primary" onclick="createNewAssembly()">â• ìƒˆ ì–´ì…ˆë¸”ë¦¬</button>
          </div>
        `;
        return;
      }
      
      // íƒ„ì†Œë°°ì¶œëŸ‰ìœ¼ë¡œ ì •ë ¬ (mÂ²ë‹¹ ê¸°ì¤€)
      const sorted = [...assemblies].sort((a, b) => {
        const aPerM2 = a.totalCarbon / a.area;
        const bPerM2 = b.totalCarbon / b.area;
        return aPerM2 - bPerM2;
      });
      
      const maxCarbonPerM2 = Math.max(...sorted.map(a => a.totalCarbon / a.area));
      const chartHeight = 340; // ì°¨íŠ¸ ìµœëŒ€ ë†’ì´ (px) - ë ˆì´ë¸” ê³µê°„ í™•ë³´
      
      chartContainer.innerHTML = sorted.map(assembly => {
        const carbonPerM2 = assembly.totalCarbon / assembly.area;
        const heightPx = Math.max(1, (carbonPerM2 / maxCarbonPerM2) * chartHeight); // ìµœì†Œ 1px
        
        return `
          <div class="bar-item">
            <div class="bar" style="height: ${heightPx}px" onclick="showDetail(${assembly.id})">
              <div class="value-label">${formatNumber(carbonPerM2, 0)}</div>
            </div>
            <div class="bar-label">${escapeHtml(assembly.name)}</div>
          </div>
        `;
      }).join('');
    }

    // ì–´ì…ˆë¸”ë¦¬ ë Œë”ë§
    function renderAssemblies() {
      const assemblies = currentFilter === 'all' 
        ? calculator.getAllAssemblies()
        : calculator.getAssembliesByType(currentFilter);
      
      const grid = document.getElementById('assembliesGrid');
      
      if (assemblies.length === 0) {
        grid.innerHTML = `
          <div class="empty-state" style="width: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 300px; grid-column: 1 / -1;">
            <div class="icon">ğŸ“¦</div>
            <h3>ì €ì¥ëœ ì–´ì…ˆë¸”ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤</h3>
            <p>ìì¬ ì„ íƒ í˜ì´ì§€ì—ì„œ ì–´ì…ˆë¸”ë¦¬ë¥¼ ë§Œë“¤ì–´ë³´ì„¸ìš”</p>
            <button class="btn btn-primary" onclick="createNewAssembly()">â• ìƒˆ ì–´ì…ˆë¸”ë¦¬</button>
          </div>
        `;
        return;
      }
      
      grid.innerHTML = assemblies.map(assembly => {
        const carbonPerM2 = assembly.totalCarbon / assembly.area;
        const grade = getCarbonGrade(carbonPerM2);
        
        return `
          <div class="assembly-card">
            <div class="preview-3d-small" id="preview3d-${assembly.id}"></div>

            <div class="card-header">
              <div>
                <div class="assembly-name">${escapeHtml(assembly.name)}</div>
                <div class="assembly-type">
                  ${getStructureTypeIcon(assembly.structureType)} 
                  ${getStructureTypeName(assembly.structureType)}
                </div>
              </div>
              <div class="badge badge-info">${grade}</div>
            </div>
            
            <div class="carbon-display-grid">
              <div class="carbon-display">
                <div class="label">mÂ²ë‹¹ ë°°ì¶œëŸ‰</div>
                <div class="value">${formatNumber(carbonPerM2, 1)}</div>
                <div class="unit">kg COâ‚‚eq/mÂ²</div>
              </div>
              <div class="carbon-display total">
                <div class="label">ì „ì²´ ë°°ì¶œëŸ‰</div>
                <div class="value">${formatNumber(assembly.totalCarbon, 0)}</div>
                <div class="unit">kg COâ‚‚eq</div>
              </div>
            </div>
            
            <div class="layers-list">
              ${assembly.layers.map(l =>
                `<span class="layer-tag">${escapeHtml(l.material.name)} (${l.thickness}mm)</span>`
              ).join('')}
            </div>
            
            <div class="metadata">
              <span>ë©´ì : ${assembly.area.toFixed(2)}mÂ²</span>
              <span>${formatDate(assembly.createdAt)}</span>
            </div>
            
            <div class="actions">
              <button class="btn btn-primary" onclick="showDetail(${assembly.id})">
                ìƒì„¸ë³´ê¸°
              </button>
              <button class="btn btn-danger" onclick="deleteAssembly(${assembly.id})">
                ì‚­ì œ
              </button>
            </div>
          </div>
        `;
      }).join('');
      
      // ê° ì–´ì…ˆë¸”ë¦¬ì˜ 3D ë Œë”ë§
      setTimeout(() => {
        cleanupThreeResources(); // ê¸°ì¡´ ë¦¬ì†ŒìŠ¤ ì •ë¦¬
        assemblies.forEach(assembly => {
          renderAssembly3D(assembly);
        });
      }, 100);
    }

    // Three.js ë¦¬ì†ŒìŠ¤ ì •ë¦¬ í•¨ìˆ˜
    function cleanupThreeResources() {
      threeResources.forEach(resource => {
        if (resource.animationId) {
          cancelAnimationFrame(resource.animationId);
        }
        if (resource.renderer) {
          resource.renderer.dispose();
        }
        if (resource.scene) {
          resource.scene.traverse(obj => {
            if (obj.geometry) obj.geometry.dispose();
            if (obj.material) {
              if (Array.isArray(obj.material)) {
                obj.material.forEach(m => m.dispose());
              } else {
                obj.material.dispose();
              }
            }
          });
        }
      });
      threeResources.length = 0;
    }

    // ì–´ì…ˆë¸”ë¦¬ 3D ë Œë”ë§
    function renderAssembly3D(assembly) {
      const container = document.getElementById(`preview3d-${assembly.id}`);
      if (!container) return;

      // ê¸°ì¡´ ìº”ë²„ìŠ¤ ì œê±°
      const existingCanvas = container.querySelector('canvas');
      if (existingCanvas) {
        existingCanvas.remove();
      }

      const width = container.clientWidth;
      const height = 150;

      const scene = new THREE.Scene();
      const camera = new THREE.PerspectiveCamera(45, width / height, 0.1, 1000);
      const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });

      renderer.setSize(width, height);
      renderer.setClearColor(0x000000, 0);
      renderer.shadowMap.enabled = true;
      renderer.shadowMap.type = THREE.PCFSoftShadowMap;
      container.appendChild(renderer.domElement);

      // ì¡°ëª… ê°œì„ 
      const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
      scene.add(ambientLight);
      
      const directionalLight1 = new THREE.DirectionalLight(0xffffff, 0.8);
      directionalLight1.position.set(5, 10, 7);
      directionalLight1.castShadow = true;
      directionalLight1.shadow.camera.near = 0.1;
      directionalLight1.shadow.camera.far = 50;
      scene.add(directionalLight1);
      
      const directionalLight2 = new THREE.DirectionalLight(0x74b9ff, 0.3);
      directionalLight2.position.set(-5, 5, -5);
      scene.add(directionalLight2);
      
      const directionalLight3 = new THREE.DirectionalLight(0xffeaa7, 0.2);
      directionalLight3.position.set(0, -5, 5);
      scene.add(directionalLight3);

      // ìì¬ë³„ ì†ì„± í•¨ìˆ˜
      function getMaterialProps(material) {
        const name = material.name.toLowerCase();
        
        if (name.includes('ì½˜í¬ë¦¬íŠ¸')) {
          return { color: 0x8b8d8f, roughness: 0.9, metalness: 0 };
        }
        if (name.includes('ë‹¨ì—´') || name.includes('xps') || name.includes('eps') || 
            name.includes('ìœ ë¦¬ë©´') || name.includes('ì•”ë©´')) {
          return { color: 0xffd93d, roughness: 0.95, metalness: 0, emissive: 0xffd93d, emissiveIntensity: 0.05 };
        }
        if (name.includes('ì„ê³ ')) {
          return { color: 0xf5f5f5, roughness: 0.7, metalness: 0 };
        }
        if (name.includes('ë§ˆë£¨') || name.includes('ëª©ì¬') || name.includes('ìŠ¤í„°ë“œ') || name.includes('ì›ëª©')) {
          return { color: 0x8b6f47, roughness: 0.8, metalness: 0 };
        }
        if (name.includes('ë²½ëŒ') || name.includes('ì ë²½')) {
          return { color: 0xa0522d, roughness: 0.95, metalness: 0 };
        }
        if (name.includes('íƒ€ì¼') || name.includes('ì„¸ë¼ë¯¹')) {
          return { color: 0xe8e8e8, roughness: 0.1, metalness: 0.3, emissive: 0xffffff, emissiveIntensity: 0.05 };
        }
        if (name.includes('ëª¨ë¥´íƒ€ë¥´') || name.includes('ëª°íƒˆ') || name.includes('ë¯¸ì¥')) {
          return { color: 0xb8b8b8, roughness: 0.85, metalness: 0 };
        }
        if (name.includes('ë°©ìˆ˜') || name.includes('ì•„ìŠ¤íŒ”íŠ¸')) {
          return { color: 0x1a1a1a, roughness: 0.3, metalness: 0.2 };
        }
        if (name.includes('ê¸ˆì†') || name.includes('ì•Œë£¨ë¯¸ëŠ„') || name.includes('ê°•íŒ')) {
          return { color: 0xc0c0c0, roughness: 0.2, metalness: 0.9, emissive: 0x444444, emissiveIntensity: 0.1 };
        }
        if (name.includes('í˜ì¸íŠ¸')) {
          return { color: 0xffffff, roughness: 0.4, metalness: 0, emissive: 0xffffff, emissiveIntensity: 0.05 };
        }
        return { color: 0x00b894, roughness: 0.7, metalness: 0 };
      }

      // ë ˆì´ì–´ ìƒì„±
      const isWall = (assembly.structureType === 'external' || assembly.structureType === 'internal');
      let pos = 0;
      const meshes = [];
      
      // ëª¨ë“  ë ˆì´ì–´ë¥¼ ë‹´ì„ ê·¸ë£¹ ìƒì„±
      const group = new THREE.Group();

      assembly.layers.forEach((layer, index) => {
        const thickness = layer.thickness / 1000; // mmë¥¼ më¡œ ë³€í™˜
        let geometry, mesh;

        // ìì¬ë³„ ì†ì„± ê°€ì ¸ì˜¤ê¸°
        const matProps = getMaterialProps(layer.material);

        if (isWall) {
          geometry = new THREE.BoxGeometry(thickness, 1.5, 1);
          mesh = new THREE.Mesh(geometry, new THREE.MeshStandardMaterial({ 
            color: matProps.color,
            roughness: matProps.roughness,
            metalness: matProps.metalness,
            emissive: matProps.emissive || 0x000000,
            emissiveIntensity: matProps.emissiveIntensity || 0,
            transparent: thickness < 0.05,
            opacity: thickness < 0.05 ? 0.85 : 1
          }));
          mesh.position.x = pos + thickness / 2;
          mesh.castShadow = true;
          mesh.receiveShadow = true;
        } else {
          geometry = new THREE.BoxGeometry(1.5, thickness, 1);
          mesh = new THREE.Mesh(geometry, new THREE.MeshStandardMaterial({ 
            color: matProps.color,
            roughness: matProps.roughness,
            metalness: matProps.metalness,
            emissive: matProps.emissive || 0x000000,
            emissiveIntensity: matProps.emissiveIntensity || 0,
            transparent: thickness < 0.05,
            opacity: thickness < 0.05 ? 0.85 : 1
          }));
          mesh.position.y = pos + thickness / 2;
          mesh.castShadow = true;
          mesh.receiveShadow = true;
        }

        // ì™¸ê³½ì„  (ë” ë‘ê»ê²Œ)
        const edges = new THREE.EdgesGeometry(geometry);
        const line = new THREE.LineSegments(edges, new THREE.LineBasicMaterial({ 
          color: 0x000000,
          linewidth: 2,
          opacity: 0.6,
          transparent: true
        }));
        mesh.add(line);

        pos += thickness;
        group.add(mesh);  // sceneì´ ì•„ë‹Œ groupì— ì¶”ê°€
        meshes.push(mesh);
      });

      // ì¤‘ì‹¬ ë§ì¶”ê¸°
      const totalSize = pos;
      meshes.forEach(mesh => {
        if (isWall) {
          mesh.position.x -= totalSize / 2;
        } else {
          mesh.position.y -= totalSize / 2;
        }
      });

      // ê·¸ë£¹ì„ sceneì— ì¶”ê°€
      scene.add(group);

      // ì¹´ë©”ë¼ ìœ„ì¹˜
      if (isWall) {
        camera.position.set(0, 0.8, 3);
      } else {
        camera.position.set(2, 1.5, 2);
      }
      camera.lookAt(0, 0, 0);

      // ì• ë‹ˆë©”ì´ì…˜ - ìë™ íšŒì „
      const resource = { renderer, scene, animationId: null };
      threeResources.push(resource);

      function animate() {
        resource.animationId = requestAnimationFrame(animate);
        group.rotation.y += 0.003; // ì²œì²œíˆ Yì¶• íšŒì „
        renderer.render(scene, camera);
      }
      animate();
    }

    // í•„í„°ë§
    function filterAssemblies(type) {
      currentFilter = type;
      
      // íƒ­ í™œì„±í™”
      document.querySelectorAll('#assemblyTabs .tab-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      event.target.classList.add('active');
      
      renderAssemblies();
    }

    function filterChart(type) {
      currentChartFilter = type;
      
      // íƒ­ í™œì„±í™”
      document.querySelectorAll('#chartTabs .tab-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      event.target.classList.add('active');
      
      renderChart();
    }

    // ìƒì„¸ ë³´ê¸°
    function showDetail(assemblyId) {
      const assembly = calculator.getAllAssemblies().find(a => a.id === assemblyId);
      if (!assembly) return;
      
      const carbonPerM2 = assembly.totalCarbon / assembly.area;
      const grade = getCarbonGrade(carbonPerM2);
      
      const modalContent = document.getElementById('modalContent');
      modalContent.innerHTML = `
        <h3 id="modalTitle">${escapeHtml(assembly.name)}</h3>
        <div class="detail-grid">
          <div class="detail-item">
            <div class="detail-label">êµ¬ì¡° íƒ€ì…</div>
            <div class="detail-value">
              ${getStructureTypeIcon(assembly.structureType)} 
              ${getStructureTypeName(assembly.structureType)}
            </div>
          </div>
          <div class="detail-item">
            <div class="detail-label">ë©´ì </div>
            <div class="detail-value">${assembly.area.toFixed(2)} mÂ²</div>
          </div>
          <div class="detail-item">
            <div class="detail-label">ì´ íƒ„ì†Œ ë°°ì¶œëŸ‰</div>
            <div class="detail-value">${formatNumber(assembly.totalCarbon, 2)} kg COâ‚‚eq</div>
          </div>
          <div class="detail-item">
            <div class="detail-label">ë‹¨ìœ„ ë©´ì ë‹¹ ë°°ì¶œëŸ‰</div>
            <div class="detail-value">${formatNumber(carbonPerM2, 2)} kg COâ‚‚eq/mÂ²</div>
          </div>
          <div class="detail-item">
            <div class="detail-label">íƒ„ì†Œ ë“±ê¸‰</div>
            <div class="detail-value">${grade}</div>
          </div>
          <div class="detail-item">
            <div class="detail-label">ìƒì„± ë‚ ì§œ</div>
            <div class="detail-value">${formatDate(assembly.createdAt)}</div>
          </div>
        </div>
        
        <h4 style="margin-top: 30px; margin-bottom: 15px;">ë ˆì´ì–´ êµ¬ì„±</h4>
        <div class="detail-grid">
          ${assembly.layers.map((layer, i) => {
            const layerCarbon = calculator.calculateLayerCarbon(layer.material, layer.thickness, assembly.area);
            return `
              <div class="detail-item">
                <div class="detail-label">${i + 1}. ${escapeHtml(layer.material.name)}</div>
                <div class="detail-value">
                  ë‘ê»˜: ${layer.thickness}mm | 
                  ë°°ì¶œ: ${formatNumber(layerCarbon, 2)} kg COâ‚‚eq
                </div>
              </div>
            `;
          }).join('')}
        </div>
      `;
      
      document.getElementById('detailModal').classList.add('show');
    }

    function closeModal() {
      document.getElementById('detailModal').classList.remove('show');
    }

    // ì–´ì…ˆë¸”ë¦¬ ì‚­ì œ
    function deleteAssembly(assemblyId) {
      if (confirm('ì´ ì–´ì…ˆë¸”ë¦¬ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        calculator.removeAssembly(assemblyId);
        init();
      }
    }

    // ì „ì²´ ì‚­ì œ
    function clearAllAssemblies() {
      if (confirm('ëª¨ë“  ì–´ì…ˆë¸”ë¦¬ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
        calculator.clearAll();
        init();
      }
    }

    // ìƒˆ ì–´ì…ˆë¸”ë¦¬ ìƒì„±
    function createNewAssembly() {
      window.location.href = 'index.html';
    }

    // CSV ë‚´ë³´ë‚´ê¸°
    function exportData() {
      const csv = calculator.exportToCSV();
      if (!csv) {
        alert('ë‚´ë³´ë‚¼ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }
      
      const filename = `jcode-assemblies-${new Date().toISOString().split('T')[0]}.csv`;
      downloadCSV(csv, filename);
      alert('CSV íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.');
    }

    // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
    document.getElementById('detailModal').addEventListener('click', (e) => {
      if (e.target.id === 'detailModal') {
        closeModal();
      }
    });

    // ESC í‚¤ë¡œ ëª¨ë‹¬ ë‹«ê¸°
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        const modal = document.getElementById('detailModal');
        if (modal.classList.contains('show')) {
          closeModal();
        }
      }
    });

    // ì´ˆê¸°í™” ì‹¤í–‰
    init();
  </script>
</body>
</html>
